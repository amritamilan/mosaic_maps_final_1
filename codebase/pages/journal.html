<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Journal</title>
  <link rel="stylesheet" href="../css/style.css" />
  <style>
    /* Lightweight page-specific styles to complement style.css */
    .journal-wrap { max-width: 1100px; margin: 3rem auto; padding: 0 1rem; }
    .journal-header { display:flex; align-items:center; justify-content: space-between; gap:1rem; margin-bottom: 1.5rem; }
    .journal-title { font-size: 2rem; color:#8A4FFF; }
    .date-picker { display:flex; align-items:center; gap:.5rem; }
    .pill { padding:.5rem .9rem; border:1px solid #E5ECF4; border-radius:999px; background:#fff; }

    .card { background:#fff; border:1px solid #E5ECF4; border-radius:16px; padding:1.25rem; box-shadow:0 2px 8px rgba(0,0,0,.04); }
    .grid { display:grid; gap:1rem; }
    @media (min-width: 900px){ .grid-2 { grid-template-columns: 1.2fr .8fr; } }

    .section-title { font-weight:600; margin-bottom:.75rem; }

    .prompt-row { display:flex; align-items:center; justify-content:space-between; gap:1rem; }
    .prompt-text { font-style: italic; color:#444; }
    .btn { border:none; background:#8A4FFF; color:#fff; padding:.6rem 1rem; border-radius:10px; cursor:pointer; }
    .btn.secondary { background:#C3BEF7; color:#222; }

    .mood-picker { display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
    .mood-chip { 
      width: 56px; 
      height: 56px; 
      border-radius: 10px; 
      border: 2px solid transparent; 
      overflow: hidden; 
      cursor: pointer;
      position: relative;
    }
    .mood-chip.selected { border-color:#8A4FFF; box-shadow:0 0 0 4px rgba(138,79,255,.12); }
    
    /* Custom mood chip styles */
    .mood-chip[data-type="custom"] span {
      display: flex !important;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: white;
      text-transform: uppercase;
      font-size: 14px;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }

    .intensity { display:flex; align-items:center; gap:12px; }
    .intensity input[type="range"] { width: 220px; }
    .intensity-badge { min-width:2.5rem; text-align:center; }

    .editor { min-height: 220px; resize: vertical; width:100%; padding:1rem; border:1px solid #E5ECF4; border-radius:12px; }

    .tags { display:flex; gap:.5rem; flex-wrap:wrap; }
        /* Default mood styles */
    .happy { background-image: url('../images/tile_happy.jpg'); background-size: cover; background-position: center; }
    .sad { background-image: url('../images/tile_sad.jpg'); background-size: cover; background-position: center; }
    .frustrated { background-image: url('../images/tile_frustrated.jpg'); background-size: cover; background-position: center; }
    .anxious { background-image: url('../images/tile_anxious.jpg'); background-size: cover; background-position: center; }    .tag { padding:.4rem .7rem; border:1px solid #E5ECF4; background:#EFFFFA; border-radius:999px; cursor:pointer; }
    .tag.active { background:#C3BEF7; }

    .meta-row { display:flex; align-items:center; justify-content:space-between; gap:1rem; flex-wrap:wrap; }
    .left-meta, .right-meta { display:flex; align-items:center; gap:1rem; flex-wrap:wrap; }

    .legend { display:grid; grid-template-columns: auto 1fr; gap:.5rem 1rem; align-items:center; }
    .legend span:first-child { 
      width: 32px; 
      height: 32px; 
      border-radius: 6px;
      display: block;
    }
    .legend .mood-tile { width:32px; height:32px; border-radius:6px; }
    .legend-item.custom-mood {
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: white;
      text-transform: uppercase;
      font-size: 12px;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }

    .toast { font-size:.9rem; color:#444; }

    /* Consistent navigation bar styling */
    nav { display:flex; justify-content:space-between; align-items:center; padding:2rem 4rem; background-color:white; border-bottom:1px solid #E5ECF4; }
    .logo { display:flex; flex-direction:column; }
    .logo-top { display:flex; align-items:center; }
    .logo-top img { height:40px; margin-right:10px; }
    .logo-top span { font-size:2rem; font-weight:bold; color:#8A4FFF; }
    .logo-tagline { font-size:0.9rem; color:#6e6e6e; margin-top:4px; }
    .nav-links { display:flex; gap:2.5rem; }
    .nav-links a { text-decoration:none; color:#8A4FFF; font-size:1rem; transition:color .3s; }
    .nav-links a:hover { color:#6e33e8; }
  </style>
</head>
<body>
  <!-- Navigation Bar -->
  <nav>
    <div class="logo">
      <div class="logo-top">
        <img src="../images/logo.png">
      </div>
    </div>
    <div class="nav-links">
      <a href="moodmap.html">mood map</a>
      <a href="myspace.html">my space</a>
      <a href="journal.html">journal</a>
      <a href="../index.html">home</a>
      <a href="login.html">login</a>
    </div>
  </nav>

  <main class="journal-wrap">
    <div class="journal-header">
      <h1 class="journal-title">Write your journal</h1>
      <div style="display: flex; gap: 1rem; align-items: center;">
        <div class="date-picker pill">
          <label for="entry-date" style="color:#555;">Date</label>
          <input id="entry-date" type="date" />
        </div>
        <button class="btn secondary" onclick="viewStoredData()">View Saved Entries</button>
      </div>
    </div>

    <!-- Modal for viewing stored data -->
    <div id="dataModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000;">
      <div style="position: relative; background: white; max-width: 800px; margin: 2rem auto; padding: 2rem; border-radius: 15px; max-height: 80vh; overflow-y: auto;">
        <h2 style="margin-bottom: 1rem; color: #8A4FFF;">Stored Data</h2>
        <div id="storedDataContent" style="margin-bottom: 1rem;"></div>
        <button class="btn" onclick="document.getElementById('dataModal').style.display='none'" style="position: absolute; top: 1rem; right: 1rem;">Close</button>
      </div>
    </div>

    <div class="grid grid-2">
      <!-- Left: prompts + editor -->
      <section class="card">
        <div class="section-title">Guided prompt</div>
        <div class="prompt-row">
          <div class="prompt-text" id="promptText">What helped you stay grounded today?</div>
          <button class="btn secondary" id="shuffleBtn" aria-label="Shuffle prompt">üîÅ Shuffle</button>
        </div>

        <div style="height:16px"></div>

        <div class="section-title">How are you feeling?</div>
        <div class="mood-picker" id="moodPicker">
          <!-- Default moods -->
          <button class="mood-chip" data-mood="happy" data-type="default">
            <span class="happy" style="width:100%; height:100%; display:block;"></span>
          </button>
          <button class="mood-chip" data-mood="sad" data-type="default">
            <span class="frustrated" style="width:100%; height:100%; display:block;"></span>
          </button>
          <button class="mood-chip" data-mood="frustrated" data-type="default">
            <span class="sad" style="width:100%; height:100%; display:block;"></span>
          </button>
          <button class="mood-chip" data-mood="anxious" data-type="default">
            <span class="anxious" style="width:100%; height:100%; display:block;"></span>
          </button>
          <!-- Custom moods will be added here -->
        </div>

        <!-- Custom mood creator -->
        <div style="margin-top: 1rem;">
          <button class="btn secondary" onclick="showCustomMoodForm()">+ Add Custom Mood</button>
        </div>

        <!-- Custom mood form -->
        <div id="customMoodForm" style="display: none; margin-top: 1rem; padding: 1rem; border: 1px solid #E5ECF4; border-radius: 12px;">
          <div style="margin-bottom: 1rem;">
            <input type="text" id="customMoodName" placeholder="Mood name" style="padding: 0.5rem; border: 1px solid #E5ECF4; border-radius: 8px; margin-right: 0.5rem;">
            <input type="color" id="customMoodColor" value="#8A4FFF" style="vertical-align: middle;">
          </div>
          <button class="btn" onclick="createCustomMood()">Create Mood</button>
          <button class="btn secondary" onclick="hideCustomMoodForm()" style="margin-left: 0.5rem;">Cancel</button>
        </div>

        <div style="height:10px"></div>
        <div class="intensity">
          <label for="intensityRange">Intensity</label>
          <input id="intensityRange" type="range" min="1" max="10" value="5" />
          <span class="pill intensity-badge" id="intensityBadge">5/10</span>
        </div>

        <div style="height:16px"></div>
        <div class="section-title">What's on your mind?</div>
        <textarea id="journalText" class="editor" placeholder="Start writing here..."></textarea>

        <div style="height:12px"></div>
        <div class="tags" id="tagRow">
          <button class="tag" data-tag="family">Family</button>
          <button class="tag" data-tag="school">School</button>
          <button class="tag" data-tag="friends">Friends</button>
          <button class="tag" data-tag="health">Health</button>
          <button class="tag" data-tag="add-custom" id="addCustomTag">+ Add custom</button>
        </div>
      </section>

      <!-- Right: legend + attachments + save -->
      <aside class="card">
        <div class="section-title">Mood legend</div>
        <div class="legend" id="moodLegend">
          <!-- Default moods -->
          <span class="happy"></span><span>happy</span>
          <span class="sad"></span><span>sad</span>
          <span class="frustrated"></span><span>frustrated</span>
          <span class="anxious"></span><span>anxious</span>
          <!-- Custom moods will be added here -->
        </div>

        <div style="height:16px"></div>
        <div class="section-title">Attach a photo (optional)</div>
        <input type="file" accept="image/*" />

        <div style="height:16px"></div>
        <div class="left-meta">
          <label class="pill"><input type="checkbox" id="privateToggle" /> Private entry</label>
        </div>

        <div style="height:16px"></div>
        <div class="meta-row">
          <div class="toast" id="autosaveHint">Auto-save is on.</div>
          <div class="right-meta">
            <button class="btn" onclick="saveEntry()">Save entry</button>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <script>
    // Global state
    const state = {
        selectedMood: null,
        selectedMoodType: null,
        customMoods: [],
        autosaveTimer: null
    };

    // Storage keys
    const STORAGE_KEYS = {
        ENTRIES: 'journalEntries',
        CUSTOM_TAGS: 'customTags',
        CUSTOM_MOODS: 'customMoods'
    };

    // Prompts
    const prompts = [
        'What helped you stay grounded today?',
        'What drained your energy today, and why?',
        'Name one small win from today.',
        'If your day was a weather pattern, what would it be?',
        'What do you want to let go of before tomorrow?'
    ];

    // Storage helper functions
    const saveToStorage = (key, data) => {
        localStorage.setItem(key, JSON.stringify(data));
    };

    const getFromStorage = (key) => {
        return JSON.parse(localStorage.getItem(key) || '[]');
    };

    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
        initializeJournal();
    });

    // Main initialization function
    function initializeJournal() {
        initializeStorage();
        state.customMoods = getFromStorage(STORAGE_KEYS.CUSTOM_MOODS);
        setupEventListeners();
        state.customMoods.forEach(mood => addCustomMoodToUI(mood));
        loadDraft();
    }

    // Initialize storage
    function initializeStorage() {
        if (!localStorage.getItem(STORAGE_KEYS.ENTRIES)) {
            localStorage.setItem(STORAGE_KEYS.ENTRIES, '[]');
        }
        if (!localStorage.getItem(STORAGE_KEYS.CUSTOM_TAGS)) {
            localStorage.setItem(STORAGE_KEYS.CUSTOM_TAGS, '[]');
        }
        if (!localStorage.getItem(STORAGE_KEYS.CUSTOM_MOODS)) {
            localStorage.setItem(STORAGE_KEYS.CUSTOM_MOODS, '[]');
        }
    }

    // Set up event listeners
    function setupEventListeners() {
        // Set default date to today
        document.getElementById('entry-date').valueAsDate = new Date();

        // Mood picker
        const moodPicker = document.getElementById('moodPicker');
        moodPicker.addEventListener('click', (e) => {
            const chip = e.target.closest('.mood-chip');
            if(!chip) return;
            document.querySelectorAll('.mood-chip').forEach(c => c.classList.remove('selected'));
            chip.classList.add('selected');
            state.selectedMood = chip.dataset.mood;
            state.selectedMoodType = chip.dataset.type || 'default';
        });

        // Intensity range
        const range = document.getElementById('intensityRange');
        const badge = document.getElementById('intensityBadge');
        range.addEventListener('input', () => {
            badge.textContent = `${range.value}/10`;
        });

        // Tags
        const tagRow = document.getElementById('tagRow');
        tagRow.addEventListener('click', (e) => {
            const btn = e.target.closest('.tag');
            if(!btn) return;
            if(btn.dataset.tag === 'add-custom'){
                const label = prompt('New tag name?');
                if(label){
                    const el = document.createElement('button');
                    el.className = 'tag active';
                    el.dataset.tag = label.toLowerCase();
                    el.textContent = label;
                    tagRow.insertBefore(el, btn);
                }
                return;
            }
            btn.classList.toggle('active');
        });

        // Editor autosave
        const editor = document.getElementById('journalText');
        const hint = document.getElementById('autosaveHint');
        editor.addEventListener('input', () => {
            hint.textContent = 'Saving‚Ä¶';
            clearTimeout(state.autosaveTimer);
            state.autosaveTimer = setTimeout(() => autosave(hint), 800);
        });

        // Prompt shuffle
        document.getElementById('shuffleBtn').addEventListener('click', () => {
            const promptText = document.getElementById('promptText');
            const next = prompts[Math.floor(Math.random() * prompts.length)];
            promptText.textContent = next;
        });
    }

    // Custom mood functions
    function showCustomMoodForm() {
        document.getElementById('customMoodForm').style.display = 'block';
    }

    function hideCustomMoodForm() {
        document.getElementById('customMoodForm').style.display = 'none';
        document.getElementById('customMoodName').value = '';
        document.getElementById('customMoodColor').value = '#8A4FFF';
    }

    function createCustomMood() {
        const nameInput = document.getElementById('customMoodName');
        const colorInput = document.getElementById('customMoodColor');
        const name = nameInput.value.trim().toLowerCase();
        const color = colorInput.value;

        if (name) {
            const newMood = { name, color };
            state.customMoods.push(newMood);
            saveToStorage(STORAGE_KEYS.CUSTOM_MOODS, state.customMoods);
            addCustomMoodToUI(newMood);
            hideCustomMoodForm();
        }
    }

    function addCustomMoodToUI(mood) {
        // Add to mood picker
        const moodPicker = document.getElementById('moodPicker');
        const moodChip = document.createElement('button');
        moodChip.className = 'mood-chip';
        moodChip.dataset.mood = mood.name;
        moodChip.dataset.type = 'custom';
        
        const moodSpan = document.createElement('span');
        moodSpan.style.width = '100%';
        moodSpan.style.height = '100%';
        moodSpan.style.backgroundColor = mood.color;
        moodSpan.textContent = mood.name.charAt(0).toUpperCase();
        
        moodChip.appendChild(moodSpan);
        moodPicker.appendChild(moodChip);

        // Add to legend
        const legend = document.getElementById('moodLegend');
        const legendSpan = document.createElement('span');
        legendSpan.style.backgroundColor = mood.color;
        legendSpan.className = 'legend-item custom-mood';
        legendSpan.textContent = mood.name.charAt(0).toUpperCase();
        legend.appendChild(legendSpan);
        
        const legendLabel = document.createElement('span');
        legendLabel.textContent = mood.name;
        legendLabel.style.color = '#333';
        legend.appendChild(legendLabel);
    }

    // Autosave function
    function autosave(hint) {
        const draftEntry = {
            date: document.getElementById('entry-date').value,
            mood: state.selectedMood,
            moodType: state.selectedMoodType,
            moodColor: state.selectedMoodType === 'custom' ? 
                state.customMoods.find(m => m.name === state.selectedMood)?.color : null,
            intensity: parseInt(document.getElementById('intensityRange').value, 10),
            text: document.getElementById('journalText').value,
            prompt: document.getElementById('promptText').textContent,
            tags: Array.from(document.querySelectorAll('.tag.active')).map(t => t.dataset.tag),
            privacy: document.getElementById('privateToggle').checked,
            lastModified: new Date().toISOString()
        };
        
        localStorage.setItem('journalDraft', JSON.stringify(draftEntry));
        hint.textContent = 'Auto-saved just now';
    }

    // Load draft
    function loadDraft() {
        // Check for mood map data first
        const tempMoodData = localStorage.getItem('tempMoodData');
        if (tempMoodData) {
            const moodMapEntry = JSON.parse(tempMoodData);
            document.getElementById('entry-date').value = moodMapEntry.date;
            
            if (moodMapEntry.mood) {
                if (moodMapEntry.type === 'custom' && moodMapEntry.color) {
                    // Create custom mood if it doesn't exist
                    if (!state.customMoods.some(m => m.name === moodMapEntry.mood)) {
                        const newMood = {
                            name: moodMapEntry.mood,
                            color: moodMapEntry.color
                        };
                        state.customMoods.push(newMood);
                        saveToStorage(STORAGE_KEYS.CUSTOM_MOODS, state.customMoods);
                        addCustomMoodToUI(newMood);
                    }
                }
                
                const moodChip = document.querySelector(`[data-mood="${moodMapEntry.mood}"]`);
                if (moodChip) {
                    moodChip.classList.add('selected');
                    state.selectedMood = moodMapEntry.mood;
                    state.selectedMoodType = moodMapEntry.type || 'default';
                }
            }
            localStorage.removeItem('tempMoodData');
            return;
        }

        // If no mood map data, check for draft
        const draft = localStorage.getItem('journalDraft');
        if (draft) {
            const draftEntry = JSON.parse(draft);
            document.getElementById('journalText').value = draftEntry.text || '';
            if (draftEntry.mood) {
                const moodChip = document.querySelector(`[data-mood="${draftEntry.mood}"]`);
                if (moodChip) {
                    moodChip.classList.add('selected');
                    state.selectedMood = draftEntry.mood;
                    state.selectedMoodType = draftEntry.moodType;
                }
            }
            document.getElementById('intensityRange').value = draftEntry.intensity || 5;
            document.getElementById('intensityBadge').textContent = `${draftEntry.intensity || 5}/10`;
            document.getElementById('privateToggle').checked = draftEntry.privacy;
            
            draftEntry.tags?.forEach(tag => {
                const tagEl = document.querySelector(`[data-tag="${tag}"]`);
                if (tagEl) tagEl.classList.add('active');
            });
        }
    }

    // Update mood map data
    function updateMoodMap(date, mood) {
        const moodData = JSON.parse(localStorage.getItem('moodData') || '{}');
        const dateKey = new Date(date).toISOString().split('T')[0];
        moodData[dateKey] = mood;
        localStorage.setItem('moodData', JSON.stringify(moodData));
    }

    // Save entry
    function saveEntry() {
        const currentFolderId = localStorage.getItem('currentFolderId');
        const entryText = document.getElementById('journalText').value.trim();
        
        if (!entryText) {
            alert('Please write something in your entry');
            return;
        }

        const entry = {
            id: Date.now(),
            folder: currentFolderId, // Link to the folder
            date: document.getElementById('entry-date').value,
            mood: state.selectedMood,
            moodType: state.selectedMoodType,
            moodColor: state.selectedMoodType === 'custom' ? 
                state.customMoods.find(m => m.name === state.selectedMood)?.color : null,
            intensity: parseInt(document.getElementById('intensityRange').value, 10),
            text: entryText,
            prompt: document.getElementById('promptText').textContent,
            tags: Array.from(document.querySelectorAll('.tag.active')).map(t => t.dataset.tag),
            privacy: document.getElementById('privateToggle').checked,
            createdAt: new Date().toISOString()
        };

        if (entry.date && entry.mood) {
            const moodMapEntry = entry.moodType === 'custom' ? {
                name: entry.mood,
                type: 'custom',
                color: entry.moodColor
            } : {
                name: entry.mood,
                type: 'default'
            };
            updateMoodMap(entry.date, moodMapEntry);
        }

        try {
            const entries = getFromStorage(STORAGE_KEYS.ENTRIES);
            entries.push(entry);
            saveToStorage(STORAGE_KEYS.ENTRIES, entries);
            document.getElementById('autosaveHint').textContent = 'Entry saved ‚úî';

            if (confirm('Entry saved! Would you like to create another entry?')) {
                // Clear form
                document.getElementById('journalText').value = '';
                document.querySelectorAll('.tag.active').forEach(tag => tag.classList.remove('active'));
                document.querySelectorAll('.mood-chip').forEach(chip => chip.classList.remove('selected'));
                document.getElementById('intensityRange').value = 5;
                document.getElementById('intensityBadge').textContent = '5/10';
                state.selectedMood = null;
                state.selectedMoodType = null;
            } else {
                window.location.href = 'moodmap.html';
            }
        } catch (error) {
            console.error('Error saving entry:', error);
            document.getElementById('autosaveHint').textContent = 'Error saving entry';
        }
    }

    // View stored data
    function viewStoredData() {
        const modal = document.getElementById('dataModal');
        const content = document.getElementById('storedDataContent');
        let html = '<div style="display: grid; gap: 1rem;">';

        // Show Journal Entries
        const entries = getFromStorage(STORAGE_KEYS.ENTRIES);
        html += '<h3>Journal Entries:</h3>';
        if (entries.length === 0) {
            html += '<p>No journal entries yet.</p>';
        } else {
            entries.forEach(entry => {
                html += `
                    <div style="border: 1px solid #eee; padding: 1rem; border-radius: 10px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <strong>Date: ${new Date(entry.date).toLocaleDateString()}</strong>
                            <span>Mood: ${entry.mood || 'Not set'}
                                ${entry.moodType === 'custom' ? 
                                    `<span style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background-color: ${entry.moodColor}; margin-left: 5px; vertical-align: middle;"></span>` 
                                    : ''}
                            </span>
                        </div>
                        <div style="margin-bottom: 0.5rem;">Intensity: ${entry.intensity}/10</div>
                        <div style="margin-bottom: 0.5rem;">Prompt: ${entry.prompt}</div>
                        <div style="white-space: pre-wrap;">${entry.text}</div>
                        ${entry.tags.length ? `<div style="margin-top: 0.5rem;">Tags: ${entry.tags.join(', ')}</div>` : ''}
                    </div>
                `;
            });
        }

        // Show Mood Map Data
        const moodData = JSON.parse(localStorage.getItem('moodData') || '{}');
        html += '<h3 style="margin-top: 1rem;">Mood Map Data:</h3>';
        if (Object.keys(moodData).length === 0) {
            html += '<p>No mood data yet.</p>';
        } else {
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.5rem;">';
            Object.entries(moodData).forEach(([date, mood]) => {
                const moodDisplay = typeof mood === 'object' ? 
                    `${mood.name}${mood.type === 'custom' ? 
                        `<span style="display: inline-block; width: 10px; height: 10px; border-radius: 50%; background-color: ${mood.color}; margin-left: 5px; vertical-align: middle;"></span>` 
                        : ''}` : mood;
                html += `
                    <div style="border: 1px solid #eee; padding: 0.5rem; border-radius: 5px;">
                        <strong>${date}</strong>: ${moodDisplay}
                    </div>
                `;
            });
            html += '</div>';
        }

        html += '</div>';
        content.innerHTML = html;
        modal.style.display = 'block';
    }
  </script>
</body>
</html>